<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rysu</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#0b0b10;color:white;font-family:Segoe UI;display:flex;height:100vh;}
.servers{width:80px;background:#050507;display:flex;flex-direction:column;align-items:center;padding-top:15px;gap:15px;}
.server-btn{width:55px;height:55px;border-radius:18px;background:#111;display:flex;align-items:center;justify-content:center;cursor:pointer;}
.server-btn:hover{background:#00f2ff;color:black;}
.channels{width:220px;background:#111;padding:10px;overflow-y:auto;}
.chat{flex:1;display:flex;flex-direction:column;}
.messages{flex:1;overflow-y:auto;padding:20px;}
.input-bar{display:flex;padding:10px;background:#111;}
input{flex:1;background:#222;border:none;color:white;padding:10px;border-radius:8px;}
button{background:#00f2ff;border:none;padding:10px;border-radius:8px;cursor:pointer;}
.msg{margin-bottom:10px;}
</style>
</head>
<body>

<div class="servers" id="serverList">
<div class="server-btn" onclick="createServer()">+</div>
</div>

<div class="channels">
<h3 id="serverName">Sunucu</h3>
<div id="channelList"></div>
<hr>
<button onclick="addFriend()">Arkadaş Ekle</button>
<div id="friendList"></div>
</div>

<div class="chat">
<div class="messages" id="messages"></div>
<div class="input-bar">
<input id="msgInput" placeholder="Mesaj...">
<button onclick="sendMessage()">Gönder</button>
</div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyCXca2LRaHFx6iZX9vhfe6lXMS9UY5nO54",
databaseURL:"https://rysu-server-default-rtdb.firebaseio.com",
projectId:"rysu-server"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let currentUser=localStorage.getItem("rysu_user");
if(!currentUser){
currentUser=prompt("Kullanıcı adın:");
localStorage.setItem("rysu_user",currentUser);
}

let currentServer=null;
let currentChannel=null;

/* SERVER LIST */
db.ref("servers").on("value",snap=>{
serverList.innerHTML='<div class="server-btn" onclick="createServer()">+</div>';
snap.forEach(s=>{
if(s.val().members && s.val().members[currentUser]){
serverList.innerHTML+=`<div class="server-btn" onclick="openServer('${s.key}')">${s.val().name[0]}</div>`;
}
});
});

/* CREATE SERVER */
function createServer(){
const name=prompt("Sunucu adı:");
if(!name)return;

const id="srv_"+Date.now();

db.ref("servers/"+id).set({
name:name,
owner:currentUser,
members:{[currentUser]:true},
channels:{genel:true}
});
}

/* OPEN SERVER */
function openServer(id){
currentServer=id;
db.ref("servers/"+id).once("value").then(snap=>{
serverName.innerText=snap.val().name;
});

db.ref("servers/"+id+"/channels").on("value",snap=>{
channelList.innerHTML="";
snap.forEach(c=>{
channelList.innerHTML+=`<div onclick="openChannel('${c.key}')"># ${c.key}</div>`;
});
});
}

/* OPEN CHANNEL */
function openChannel(ch){
currentChannel=ch;
listenMessages();
}

/* MESSAGES */
function sendMessage(){
if(!currentServer||!currentChannel)return;
db.ref("messages/"+currentServer+"/"+currentChannel).push({
user:currentUser,
text:msgInput.value
});
msgInput.value="";
}

function listenMessages(){
db.ref("messages/"+currentServer+"/"+currentChannel).on("value",snap=>{
messages.innerHTML="";
snap.forEach(m=>{
const d=m.val();
messages.innerHTML+=`<div class="msg"><b>${d.user}</b>: ${d.text}</div>`;
});
});
}

/* FRIEND SYSTEM */
function addFriend(){
const name=prompt("Kullanıcı adı:");
if(!name)return;

db.ref("users/"+currentUser+"/friends/"+name).set(true);
db.ref("users/"+name+"/friends/"+currentUser).set(true);
}

db.ref("users/"+currentUser+"/friends").on("value",snap=>{
friendList.innerHTML="<h4>Arkadaşlar</h4>";
snap.forEach(f=>{
friendList.innerHTML+=`<div onclick="openDM('${f.key}')">@ ${f.key}</div>`;
});
});

/* DM */
function openDM(friend){
currentServer=null;
currentChannel=null;
const id=[currentUser,friend].sort().join("_");

db.ref("dms/"+id).on("value",snap=>{
messages.innerHTML="";
snap.forEach(m=>{
const d=m.val();
messages.innerHTML+=`<div class="msg"><b>${d.user}</b>: ${d.text}</div>`;
});
});

sendMessage=function(){
db.ref("dms/"+id).push({
user:currentUser,
text:msgInput.value
});
msgInput.value="";
};
}
</script>

</body>
</html>