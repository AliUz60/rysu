<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arkada≈ü Sohbet ¬∑ Premium</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, system-ui, sans-serif; }
        body { height: 100vh; display: flex; background-color: #1e2124; overflow: hidden; transition: background-color 0.3s; }
        body.light-mode { background-color: #f2f3f5; }
        body.light-mode .servers { background-color: #e3e5e8; }
        body.light-mode .channels-panel { background-color: #f2f3f5; color: #2e3338; }
        body.light-mode .chat-area { background-color: #ffffff; }
        body.light-mode .message-text { background-color: #e3e5e8; color: #2e3338; }
        /* Sol sunucu √ßubuƒüu */
        .servers { width: 72px; background-color: #1a1c1f; display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px; overflow-y: auto; }
        .server-icon { width: 48px; height: 48px; border-radius: 30px; background: #2b2f33; display: flex; align-items: center; justify-content: center; color: #d1d5da; font-size: 20px; font-weight: bold; transition: 0.1s; cursor: pointer; position: relative; }
        .server-icon.active { border-radius: 16px; background: #3a6ea5; color: white; }
        .server-icon:hover { border-radius: 16px; background: #3a6ea5; color: white; }
        .server-divider { width: 32px; height: 2px; background-color: #2b2f33; margin: 4px 0; }
        .server-icon.dm { background: #2f3136; color: #3ba55d; }
        .server-icon.add-server { background: #2f3136; color: #3a6ea5; font-size: 24px; }

        .channels-panel { width: 240px; background-color: #2b2f33; display: flex; flex-direction: column; color: #b9bbbe; }
        .server-name { padding: 18px 16px; font-weight: 600; color: #ffffff; border-bottom: 1px solid #1e2124; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .channel-category { padding: 16px 16px 4px 16px; text-transform: uppercase; font-size: 12px; font-weight: 600; color: #8e9297; display: flex; align-items: center; justify-content: space-between; }
        .channel { padding: 6px 16px; margin: 1px 8px; border-radius: 6px; display: flex; align-items: center; gap: 8px; color: #b9bbbe; cursor: pointer; font-size: 15px; }
        .channel:hover { background-color: #35393f; color: #dcddde; }
        .channel.active { background-color: #3d434a; color: #ffffff; }
        .channel i { font-size: 20px; width: 22px; text-align: center; }
        .user-footer { padding: 16px; border-top: 1px solid #1e2124; display: flex; align-items: center; gap: 8px; margin-top: auto; }

        .chat-area { flex: 1; background-color: #31363b; display: flex; flex-direction: column; }
        .chat-header { padding: 12px 20px; background-color: #2f3338; border-bottom: 1px solid #1e2124; display: flex; align-items: center; gap: 10px; color: #ffffff; font-weight: 600; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .message { display: flex; gap: 16px; align-items: flex-start; }
        .message-avatar { width: 40px; height: 40px; border-radius: 20px; background-color: #3a6ea5; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-transform: uppercase; flex-shrink: 0; }
        .message-content { flex: 1; }
        .message-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; }
        .message-author { font-weight: 600; color: #ffffff; }
        .message-time { font-size: 11px; color: #8e9297; }
        .message-text { color: #d1d5da; word-wrap: break-word; background-color: #2f3338; padding: 8px 12px; border-radius: 18px; max-width: 70%; border-top-left-radius: 4px; }
        .own-message .message-text { background-color: #3a6ea5; color: white; border-top-left-radius: 18px; border-top-right-radius: 4px; margin-left: auto; }
        .own-message { flex-direction: row-reverse; }
        .own-message .message-header { justify-content: flex-end; }
        .message-image { max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer; }
        .message-input-area { padding: 20px; background-color: #2f3338; border-top: 1px solid #1e2124; }
        .input-wrapper { background-color: #40464b; border-radius: 8px; padding: 0 16px; display: flex; align-items: center; }
        .input-wrapper input { flex: 1; background: transparent; border: none; padding: 12px 0; color: #dcddde; font-size: 15px; outline: none; }
        .input-wrapper input::placeholder { color: #7b7f85; }
        .input-wrapper i { color: #b9bbbe; font-size: 20px; margin-left: 12px; cursor: pointer; }
        .input-wrapper i:hover { color: #dcddde; }

        .users-panel { width: 240px; background-color: #2b2f33; padding: 16px 8px; color: #b9bbbe; overflow-y: auto; }
        .users-title { text-transform: uppercase; font-size: 12px; font-weight: 600; padding: 0 8px 8px 8px; border-bottom: 1px solid #1e2124; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .user-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; justify-content: space-between; }
        .user-item:hover { background-color: #35393f; }
        .user-info { display: flex; align-items: center; gap: 8px; flex:1; }
        .user-status { width: 10px; height: 10px; border-radius: 50%; background-color: #3ba55d; }
        .user-status.offline { background-color: #747f8d; }
        .user-name { font-size: 14px; font-weight: 500; color: #dcddde; }
        .delete-friend { color: #b9bbbe; visibility: hidden; }
        .user-item:hover .delete-friend { visibility: visible; }
        .delete-friend:hover { color: #f04747; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: #2f3338; border-radius: 8px; width: 400px; max-width: 90%; padding: 20px; color: white; box-shadow: 0 0 20px black; }
        .modal-content h2 { margin-bottom: 16px; color: #fff; }
        .modal-content input { width: 100%; padding: 10px; background: #1e2124; border: 1px solid #3d434a; color: white; border-radius: 4px; margin-bottom: 16px; }
        .modal-content button { background: #3a6ea5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 8px; }
        .modal-content button.secondary { background: #3d434a; }
        .modal-content button:hover { filter: brightness(1.2); }
        .modal-content select { width: 100%; padding: 10px; background: #1e2124; border: 1px solid #3d434a; color: white; border-radius: 4px; margin-bottom: 16px; }

        #file-input { display: none; }

        /* Context menu (saƒü tƒ±k men√ºs√º) */
        .context-menu { position: absolute; background: #2f3338; border: 1px solid #1e2124; border-radius: 4px; display: none; z-index: 2000; }
        .context-menu ul { list-style: none; padding: 4px 0; }
        .context-menu li { padding: 8px 20px; color: #dcddde; cursor: pointer; }
        .context-menu li:hover { background-color: #3a6ea5; color: white; }
    </style>
</head>
<body>
    <!-- SOL SUNUCU Lƒ∞STESƒ∞ -->
    <div class="servers" id="server-list"></div>

    <!-- KANALLAR PANELƒ∞ -->
    <div class="channels-panel">
        <div class="server-name" id="current-server-name">
            <span id="server-name-text">genel</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div id="channel-list"></div>
        <div class="user-footer" id="user-footer">
            <div style="width:32px;height:32px;border-radius:16px;background:#3a6ea5;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;" id="avatar-letter">K</div>
            <div style="flex:1;color:white;font-size:14px;font-weight:500;" id="current-username">Y√ºkleniyor...</div>
            <!-- Sadece ayarlar butonu kaldƒ±, mikrofon ve kulaklƒ±k yok -->
            <i class="fas fa-cog" id="settings-button" style="cursor:pointer;"></i>
        </div>
    </div>

    <!-- ANA SOHBET ALANI -->
    <div class="chat-area">
        <div class="chat-header" id="chat-header">
            <i class="fas fa-hashtag" id="channel-icon"></i>
            <span id="current-channel">genel</span>
        </div>
        <div class="messages-container" id="messages-container"></div>
        <div class="message-input-area">
            <div class="input-wrapper">
                <input type="text" id="message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n...">
                <i class="fas fa-paperclip" id="attach-button" onclick="document.getElementById('file-input').click()"></i>
                <i class="fas fa-smile"></i>
                <i class="fas fa-paper-plane" id="send-button"></i>
            </div>
        </div>
    </div>

    <!-- SAƒû ARKADA≈û Lƒ∞STESƒ∞ -->
    <div class="users-panel" id="friends-panel">
        <div class="users-title">
            Arkada≈ülar
            <i class="fas fa-user-plus" id="add-friend-btn" onclick="openFriendModal()" style="cursor:pointer;"></i>
        </div>
        <div id="friends-list"></div>
        <div class="users-title" style="margin-top:20px;">Direkt Mesajlar</div>
        <div id="dm-list"></div>
    </div>

    <!-- MODALLAR -->
    <div class="modal active" id="username-modal">
        <div class="modal-content">
            <h2>‚ú® Arkada≈ü Sohbet'e Ho≈ü Geldin</h2>
            <p>Kullanƒ±cƒ± adƒ±nƒ± gir, hemen ba≈üla!</p>
            <input type="text" id="modal-username" placeholder="Kullanƒ±cƒ± adƒ±" value="">
            <button id="modal-username-save">Ba≈üla</button>
            <button class="secondary" id="modal-username-cancel">ƒ∞ptal</button>
        </div>
    </div>

    <div class="modal" id="server-modal">
        <div class="modal-content">
            <h2>‚ûï Yeni Sunucu Olu≈ütur</h2>
            <input type="text" id="new-server-name" placeholder="Sunucu adƒ±">
            <button onclick="createServer()">Olu≈ütur</button>
            <button class="secondary" onclick="closeServerModal()">ƒ∞ptal</button>
        </div>
    </div>

    <div class="modal" id="friend-modal">
        <div class="modal-content">
            <h2>üë§ Arkada≈ü Ekle</h2>
            <input type="text" id="friend-username" placeholder="Kullanƒ±cƒ± adƒ±">
            <button onclick="addFriend()">Ekle</button>
            <button class="secondary" onclick="closeFriendModal()">ƒ∞ptal</button>
        </div>
    </div>

    <!-- Ayarlar modalƒ± -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Ayarlar</h2>
            <label>Kullanƒ±cƒ± Adƒ±</label>
            <input type="text" id="settings-username" placeholder="Yeni kullanƒ±cƒ± adƒ±">
            <button onclick="changeUsername()">Deƒüi≈ütir</button>
            <br><br>
            <label>Tema</label>
            <select id="theme-select">
                <option value="dark">Koyu</option>
                <option value="light">Aydƒ±nlƒ±k</option>
            </select>
            <br><br>
            <p style="color: #f04747;"><i class="fas fa-exclamation-triangle"></i> Sesli arama √∂zelliƒüi yok (Firebase + HTML ile sƒ±nƒ±rlƒ±).</p>
            <button class="secondary" onclick="closeSettingsModal()">Kapat</button>
        </div>
    </div>

    <!-- Gizli dosya inputu -->
    <input type="file" id="file-input" accept="image/*" onchange="uploadImage(this)">

    <!-- Saƒü tƒ±k men√ºs√º (sunucu silme i√ßin) -->
    <div class="context-menu" id="server-context-menu">
        <ul>
            <li id="delete-server-option">Sunucuyu Sil</li>
        </ul>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCXca2LRaHFx6iZX9vhfe6lXMS9UY5nO54",
            authDomain: "rysu-server.firebaseapp.com",
            databaseURL: "https://rysu-server-default-rtdb.firebaseio.com",
            projectId: "rysu-server",
            storageBucket: "rysu-server.firebasestorage.app",
            messagingSenderId: "253844771451",
            appId: "1:253844771451:web:bd370ae5a93eae66fcc8de",
            measurementId: "G-T632DDDX6L"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        // Global deƒüi≈ükenler
        let currentUser = localStorage.getItem('chat_username') || null;
        let currentServer = 'genel';
        let currentChannel = 'genel';
        let currentDMFriend = null;
        let contextMenu = document.getElementById('server-context-menu');
        let selectedServerForDelete = null;

        // DOM elementleri
        const usernameModal = document.getElementById('username-modal');
        const modalUsernameInput = document.getElementById('modal-username');
        const modalUsernameSave = document.getElementById('modal-username-save');
        const modalUsernameCancel = document.getElementById('modal-username-cancel');
        const serverModal = document.getElementById('server-modal');
        const friendModal = document.getElementById('friend-modal');
        const settingsModal = document.getElementById('settings-modal');
        const settingsUsername = document.getElementById('settings-username');
        const themeSelect = document.getElementById('theme-select');
        const messagesContainer = document.getElementById('messages-container');
        const channelListDiv = document.getElementById('channel-list');
        const currentChannelSpan = document.getElementById('current-channel');
        const serverNameSpan = document.getElementById('server-name-text');
        const currentUsernameSpan = document.getElementById('current-username');
        const avatarLetter = document.getElementById('avatar-letter');
        const chatHeaderIcon = document.getElementById('channel-icon');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const fileInput = document.getElementById('file-input');
        const settingsButton = document.getElementById('settings-button');

        // Kullanƒ±cƒ± adƒ± kontrol√º
        if (currentUser) {
            usernameModal.classList.remove('active');
            initApp();
        } else {
            usernameModal.classList.add('active');
        }

        modalUsernameSave.addEventListener('click', () => {
            const name = modalUsernameInput.value.trim();
            if (name) {
                currentUser = name;
                localStorage.setItem('chat_username', currentUser);
                usernameModal.classList.remove('active');
                db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
                initApp();
            } else {
                alert('L√ºtfen bir kullanƒ±cƒ± adƒ± girin.');
            }
        });

        modalUsernameCancel.addEventListener('click', () => {
            currentUser = 'Arkada≈ü';
            localStorage.setItem('chat_username', currentUser);
            usernameModal.classList.remove('active');
            db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
            initApp();
        });

        function initApp() {
            currentUsernameSpan.textContent = currentUser;
            avatarLetter.textContent = currentUser.charAt(0).toUpperCase();

            // Varsayƒ±lan sunucuyu kontrol et
            db.ref('servers/genel').once('value', (snap) => {
                if (!snap.exists()) {
                    db.ref('servers/genel').set({
                        name: 'genel',
                        channels: { genel: true, random: true, sohbet: true }
                    });
                }
            });

            // Sunucu listesini dinle
            db.ref('servers').on('value', (snap) => {
                renderServerList(snap.val() || {});
            });

            // Arkada≈ü listesini dinle
            db.ref('users/' + currentUser + '/friends').on('value', (snap) => {
                renderFriendsList(snap.val() || {});
            });

            // Varsayƒ±lan sunucuya ge√ß
            switchServer('genel');

            // Saƒü tƒ±k men√ºs√ºn√º gizle
            document.addEventListener('click', () => contextMenu.style.display = 'none');
            document.addEventListener('contextmenu', (e) => e.preventDefault()); // Sayfada genel saƒü tƒ±kkƒ± engelle

            // Ayarlar butonu
            settingsButton.addEventListener('click', openSettingsModal);

            // Tema kontrol√º (localStorage)
            const savedTheme = localStorage.getItem('theme') || 'dark';
            themeSelect.value = savedTheme;
            applyTheme(savedTheme);
            themeSelect.addEventListener('change', (e) => {
                applyTheme(e.target.value);
                localStorage.setItem('theme', e.target.value);
            });
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
            } else {
                document.body.classList.remove('light-mode');
            }
        }

        function renderServerList(serversData) {
            let html = '';
            for (let id in serversData) {
                const activeClass = (id === currentServer && !currentDMFriend) ? 'active' : '';
                html += `<div class="server-icon ${activeClass}" data-server-id="${id}" oncontextmenu="showServerContextMenu(event, '${id}')" onclick="switchServer('${id}')">${serversData[id].name.charAt(0).toUpperCase()}</div>`;
            }
            html += `<div class="server-divider"></div>`;
            html += `<div class="server-icon add-server" onclick="openServerModal()"><i class="fas fa-plus"></i></div>`;
            html += `<div class="server-icon dm ${!currentServer && currentDMFriend ? 'active' : ''}" onclick="openDMHome()"><i class="fas fa-comment"></i></div>`;
            document.getElementById('server-list').innerHTML = html;
        }

        function renderFriendsList(friendsData) {
            let friendsHtml = '';
            let dmHtml = '';
            for (let friend in friendsData) {
                friendsHtml += `<div class="user-item">
                    <div class="user-info" onclick="openDM('${friend}')">
                        <div class="user-status"></div>
                        <span class="user-name">${friend}</span>
                    </div>
                    <i class="fas fa-trash delete-friend" onclick="deleteFriend('${friend}')"></i>
                </div>`;
                dmHtml += `<div class="user-item" onclick="openDM('${friend}')">
                    <div class="user-info">
                        <div class="user-status"></div>
                        <span class="user-name">${friend}</span>
                    </div>
                </div>`;
            }
            document.getElementById('friends-list').innerHTML = friendsHtml;
            document.getElementById('dm-list').innerHTML = dmHtml;
        }

        function switchServer(serverId) {
            if (!serverId) return;
            currentServer = serverId;
            currentDMFriend = null;
            document.getElementById('current-server-name').style.display = 'flex';
            serverNameSpan.textContent = serverId;
            // Sunucu ikonlarƒ±nƒ± g√ºncelle
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            const activeServerIcon = document.querySelector(`.server-icon[data-server-id="${serverId}"]`);
            if (activeServerIcon) activeServerIcon.classList.add('active');
            // Kanallarƒ± y√ºkle
            db.ref('servers/' + serverId + '/channels').once('value', (snap) => {
                const channels = snap.val() || {};
                let chHtml = '<div class="channel-category">METƒ∞N KANALLARI</div>';
                for (let ch in channels) {
                    const active = (ch === currentChannel) ? 'active' : '';
                    chHtml += `<div class="channel ${active}" onclick="switchChannel('${ch}')"><i class="fas fa-hashtag"></i>${ch}</div>`;
                }
                channelListDiv.innerHTML = chHtml;
                // Eƒüer mevcut kanal bu sunucuda yoksa ilk kanala ge√ß
                if (!channels[currentChannel]) {
                    const firstCh = Object.keys(channels)[0] || 'genel';
                    switchChannel(firstCh);
                } else {
                    // Mevcut kanalƒ± y√ºkle
                    loadMessages('server', currentServer + '_' + currentChannel);
                }
            });
        }

        function switchChannel(channel) {
            currentChannel = channel;
            currentDMFriend = null;
            document.querySelectorAll('.channel').forEach(ch => ch.classList.remove('active'));
            const activeChannel = Array.from(document.querySelectorAll('.channel')).find(el => el.textContent.trim() === channel);
            if (activeChannel) activeChannel.classList.add('active');
            currentChannelSpan.textContent = channel;
            chatHeaderIcon.className = 'fas fa-hashtag';
            loadMessages('server', currentServer + '_' + channel);
        }

        function openDM(friendUsername) {
            currentDMFriend = friendUsername;
            currentServer = null;
            // Sunucu ikonlarƒ±nƒ± g√ºncelle
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            document.querySelector('.server-icon.dm').classList.add('active');
            document.getElementById('current-server-name').style.display = 'none';
            channelListDiv.innerHTML = '<div class="channel-category">DM</div><div class="channel active"><i class="fas fa-comment"></i> ' + friendUsername + '</div>';
            currentChannelSpan.textContent = friendUsername;
            chatHeaderIcon.className = 'fas fa-comment';
            const roomId = [currentUser, friendUsername].sort().join('_');
            loadMessages('dm', roomId);
        }

        function openDMHome() {
            currentDMFriend = null;
            currentServer = null;
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            document.querySelector('.server-icon.dm').classList.add('active');
            document.getElementById('current-server-name').style.display = 'none';
            channelListDiv.innerHTML = '<div class="channel-category">DOƒûRUDAN MESAJLAR</div><div class="channel"><i class="fas fa-info-circle"></i> Bir arkada≈ü se√ßin</div>';
            currentChannelSpan.textContent = 'Direkt Mesajlar';
            chatHeaderIcon.className = 'fas fa-comment';
            messagesContainer.innerHTML = '';
        }

        function loadMessages(type, id) {
            messagesContainer.innerHTML = '';
            let ref = (type === 'server') ? db.ref('messages/server/' + id) : db.ref('messages/dm/' + id);
            ref.off();
            ref.orderByChild('timestamp').on('child_added', (snap) => {
                const msg = snap.val();
                appendMessage(msg);
            });
        }

        function appendMessage(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            if (msg.username === currentUser) {
                messageDiv.classList.add('own-message');
            }
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : '';
            const avatarLetter = msg.username ? msg.username.charAt(0).toUpperCase() : '?';
            let contentHtml = '';
            if (msg.text) {
                contentHtml += `<div class="message-text">${escapeHtml(msg.text)}</div>`;
            }
            if (msg.imageUrl) {
                contentHtml += `<img src="${escapeHtml(msg.imageUrl)}" class="message-image" onclick="window.open(this.src)">`;
            }
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarLetter}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${escapeHtml(msg.username)}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    ${contentHtml}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function sendMessage(text, imageUrl = null) {
            if (!text && !imageUrl) return;
            let ref;
            if (currentDMFriend) {
                const roomId = [currentUser, currentDMFriend].sort().join('_');
                ref = db.ref('messages/dm/' + roomId);
            } else {
                ref = db.ref('messages/server/' + currentServer + '_' + currentChannel);
            }
            const msg = {
                username: currentUser,
                text: text || '',
                timestamp: Date.now(),
            };
            if (imageUrl) msg.imageUrl = imageUrl;
            ref.push(msg);
        }

        sendButton.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text) {
                sendMessage(text);
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const text = messageInput.value.trim();
                if (text) {
                    sendMessage(text);
                    messageInput.value = '';
                }
            }
        });

        // Resim y√ºkleme
        window.uploadImage = (input) => {
            const file = input.files[0];
            if (!file) return;
            const storageRef = storage.ref('images/' + Date.now() + '_' + file.name);
            const task = storageRef.put(file);
            task.on('state_changed', null, null, () => {
                task.snapshot.ref.getDownloadURL().then(url => {
                    sendMessage('', url);
                });
            });
        };

        // Modal i≈ülevleri
        window.openServerModal = () => {
            serverModal.classList.add('active');
        };
        window.closeServerModal = () => {
            serverModal.classList.remove('active');
            document.getElementById('new-server-name').value = '';
        };
        window.createServer = () => {
            const name = document.getElementById('new-server-name').value.trim();
            if (name) {
                db.ref('servers/' + name).set({
                    name: name,
                    channels: { genel: true, random: true, sohbet: true }
                });
                closeServerModal();
                switchServer(name);
            } else {
                alert('Sunucu adƒ± bo≈ü olamaz.');
            }
        };

        window.openFriendModal = () => {
            friendModal.classList.add('active');
        };
        window.closeFriendModal = () => {
            friendModal.classList.remove('active');
            document.getElementById('friend-username').value = '';
        };
        window.addFriend = () => {
            const friendName = document.getElementById('friend-username').value.trim();
            if (friendName && friendName !== currentUser) {
                db.ref('users/' + friendName).once('value', (snap) => {
                    if (snap.exists()) {
                        db.ref('users/' + currentUser + '/friends/' + friendName).set(Date.now());
                        db.ref('users/' + friendName + '/friends/' + currentUser).set(Date.now());
                        closeFriendModal();
                    } else {
                        alert('Bu kullanƒ±cƒ± bulunamadƒ±.');
                    }
                });
            } else {
                alert('Ge√ßerli bir kullanƒ±cƒ± adƒ± girin.');
            }
        };

        // Arkada≈ü silme
        window.deleteFriend = (friendName) => {
            if (confirm(friendName + ' adlƒ± kullanƒ±cƒ±yƒ± arkada≈ülarƒ±ndan √ßƒ±karmak istediƒüine emin misin?')) {
                db.ref('users/' + currentUser + '/friends/' + friendName).remove();
                db.ref('users/' + friendName + '/friends/' + currentUser).remove();
                if (currentDMFriend === friendName) {
                    openDMHome();
                }
            }
        };

        // Sunucu silme i√ßin saƒü tƒ±k men√ºs√º
        window.showServerContextMenu = (event, serverId) => {
            event.preventDefault();
            selectedServerForDelete = serverId;
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
        };

        document.getElementById('delete-server-option').addEventListener('click', () => {
            if (selectedServerForDelete) {
                if (selectedServerForDelete === 'genel') {
                    alert('Ana sunucu silinemez.');
                } else if (confirm('"' + selectedServerForDelete + '" sunucusunu silmek istediƒüine emin misin?')) {
                    db.ref('servers/' + selectedServerForDelete).remove().then(() => {
                        if (currentServer === selectedServerForDelete) {
                            switchServer('genel');
                        }
                    });
                }
                contextMenu.style.display = 'none';
                selectedServerForDelete = null;
            }
        });

        // Ayarlar modalƒ±
        function openSettingsModal() {
            settingsUsername.value = currentUser;
            settingsModal.classList.add('active');
        }

        window.closeSettingsModal = () => {
            settingsModal.classList.remove('active');
        };

        window.changeUsername = () => {
            const newName = settingsUsername.value.trim();
            if (newName && newName !== currentUser) {
                // Firebase'de kullanƒ±cƒ± adƒ± deƒüi≈üikliƒüi: eski kullanƒ±cƒ±yƒ± sil, yeni ekle
                // Not: Bu basit √∂rnekte sadece localStorage ve g√∂r√ºnen adƒ± deƒüi≈ütiriyoruz.
                // Daha karma≈üƒ±k yapƒ±da t√ºm mesajlardaki kullanƒ±cƒ± adlarƒ±nƒ± da g√ºncellemek gerekir.
                // ≈ûimdilik sadece oturumdaki adƒ± deƒüi≈ütirelim.
                const oldUser = currentUser;
                currentUser = newName;
                localStorage.setItem('chat_username', currentUser);
                currentUsernameSpan.textContent = currentUser;
                avatarLetter.textContent = currentUser.charAt(0).toUpperCase();
                // Firebase'de users listesini g√ºncelle (eskiyi sil, yeni ekle)
                db.ref('users/' + oldUser).remove();
                db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
                // Arkada≈ülƒ±k ili≈ükilerini de g√ºncellemek gerekir ama basitlik i√ßin ≈üimdilik atlƒ±yoruz.
                closeSettingsModal();
                alert('Kullanƒ±cƒ± adƒ± deƒüi≈ütirildi. Not: Arkada≈ülƒ±klar korunmaz, yeniden eklenmesi gerekebilir.');
            } else if (newName === currentUser) {
                alert('Aynƒ± kullanƒ±cƒ± adƒ±nƒ± girdiniz.');
            } else {
                alert('Ge√ßerli bir kullanƒ±cƒ± adƒ± girin.');
            }
        };
    </script>
</body>
</html>