<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArkadaÅŸ Sohbet Â· Premium</title>
    <!-- Firebase SDK (9.22.2) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, system-ui, sans-serif; }
        body { height: 100vh; display: flex; background-color: #1e2124; overflow: hidden; }
        /* Sol sunucu Ã§ubuÄŸu */
        .servers { width: 72px; background-color: #1a1c1f; display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px; overflow-y: auto; }
        .server-icon { width: 48px; height: 48px; border-radius: 30px; background: #2b2f33; display: flex; align-items: center; justify-content: center; color: #d1d5da; font-size: 20px; font-weight: bold; transition: 0.1s; cursor: pointer; position: relative; }
        .server-icon.active { border-radius: 16px; background: #3a6ea5; color: white; }
        .server-icon:hover { border-radius: 16px; background: #3a6ea5; color: white; }
        .server-divider { width: 32px; height: 2px; background-color: #2b2f33; margin: 4px 0; }
        .server-icon.dm { background: #2f3136; color: #3ba55d; }
        .server-icon.add-server { background: #2f3136; color: #3a6ea5; font-size: 24px; }

        /* Kanallar paneli */
        .channels-panel { width: 240px; background-color: #2b2f33; display: flex; flex-direction: column; color: #b9bbbe; }
        .server-name { padding: 18px 16px; font-weight: 600; color: #ffffff; border-bottom: 1px solid #1e2124; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .channel-category { padding: 16px 16px 4px 16px; text-transform: uppercase; font-size: 12px; font-weight: 600; color: #8e9297; display: flex; align-items: center; justify-content: space-between; }
        .channel { padding: 6px 16px; margin: 1px 8px; border-radius: 6px; display: flex; align-items: center; gap: 8px; color: #b9bbbe; cursor: pointer; font-size: 15px; }
        .channel:hover { background-color: #35393f; color: #dcddde; }
        .channel.active { background-color: #3d434a; color: #ffffff; }
        .channel i { font-size: 20px; width: 22px; text-align: center; }
        .user-footer { padding: 16px; border-top: 1px solid #1e2124; display: flex; align-items: center; gap: 8px; margin-top: auto; }

        /* Ana sohbet alanÄ± */
        .chat-area { flex: 1; background-color: #31363b; display: flex; flex-direction: column; }
        .chat-header { padding: 12px 20px; background-color: #2f3338; border-bottom: 1px solid #1e2124; display: flex; align-items: center; gap: 10px; color: #ffffff; font-weight: 600; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        .message { display: flex; gap: 16px; align-items: flex-start; }
        .message-avatar { width: 40px; height: 40px; border-radius: 20px; background-color: #3a6ea5; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-transform: uppercase; flex-shrink: 0; }
        .message-content { flex: 1; }
        .message-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; }
        .message-author { font-weight: 600; color: #ffffff; }
        .message-time { font-size: 11px; color: #8e9297; }
        .message-text { color: #d1d5da; word-wrap: break-word; background-color: #2f3338; padding: 8px 12px; border-radius: 18px; max-width: 70%; border-top-left-radius: 4px; }
        .own-message .message-text { background-color: #3a6ea5; color: white; border-top-left-radius: 18px; border-top-right-radius: 4px; margin-left: auto; }
        .own-message { flex-direction: row-reverse; }
        .own-message .message-header { justify-content: flex-end; }
        .message-image { max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer; }
        .message-input-area { padding: 20px; background-color: #2f3338; border-top: 1px solid #1e2124; }
        .input-wrapper { background-color: #40464b; border-radius: 8px; padding: 0 16px; display: flex; align-items: center; }
        .input-wrapper input { flex: 1; background: transparent; border: none; padding: 12px 0; color: #dcddde; font-size: 15px; outline: none; }
        .input-wrapper input::placeholder { color: #7b7f85; }
        .input-wrapper i { color: #b9bbbe; font-size: 20px; margin-left: 12px; cursor: pointer; }
        .input-wrapper i:hover { color: #dcddde; }

        /* SaÄŸ panel (arkadaÅŸ listesi) */
        .users-panel { width: 240px; background-color: #2b2f33; padding: 16px 8px; color: #b9bbbe; overflow-y: auto; }
        .users-title { text-transform: uppercase; font-size: 12px; font-weight: 600; padding: 0 8px 8px 8px; border-bottom: 1px solid #1e2124; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .user-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; }
        .user-item:hover { background-color: #35393f; }
        .user-status { width: 10px; height: 10px; border-radius: 50%; background-color: #3ba55d; }
        .user-status.offline { background-color: #747f8d; }
        .user-name { font-size: 14px; font-weight: 500; color: #dcddde; }

        /* Modal stilleri */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: #2f3338; border-radius: 8px; width: 400px; max-width: 90%; padding: 20px; color: white; box-shadow: 0 0 20px black; }
        .modal-content h2 { margin-bottom: 16px; color: #fff; }
        .modal-content input { width: 100%; padding: 10px; background: #1e2124; border: 1px solid #3d434a; color: white; border-radius: 4px; margin-bottom: 16px; }
        .modal-content button { background: #3a6ea5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 8px; }
        .modal-content button.secondary { background: #3d434a; }
        .modal-content button:hover { filter: brightness(1.2); }

        /* Dosya yÃ¼kleme butonu */
        #file-input { display: none; }
    </style>
</head>
<body>
    <!-- SOL SUNUCU LÄ°STESÄ° -->
    <div class="servers" id="server-list"></div>

    <!-- KANALLAR PANELÄ° -->
    <div class="channels-panel">
        <div class="server-name" id="current-server-name">
            <span id="server-name-text">genel</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div id="channel-list"></div>
        <div class="user-footer" id="user-footer">
            <div style="width:32px;height:32px;border-radius:16px;background:#3a6ea5;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;" id="avatar-letter">K</div>
            <div style="flex:1;color:white;font-size:14px;font-weight:500;" id="current-username">YÃ¼kleniyor...</div>
            <i class="fas fa-microphone"></i>
            <i class="fas fa-headphones"></i>
            <i class="fas fa-cog"></i>
        </div>
    </div>

    <!-- ANA SOHBET ALANI -->
    <div class="chat-area">
        <div class="chat-header" id="chat-header">
            <i class="fas fa-hashtag" id="channel-icon"></i>
            <span id="current-channel">genel</span>
        </div>
        <div class="messages-container" id="messages-container"></div>
        <div class="message-input-area">
            <div class="input-wrapper">
                <input type="text" id="message-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n...">
                <i class="fas fa-paperclip" id="attach-button" onclick="document.getElementById('file-input').click()"></i>
                <i class="fas fa-smile"></i>
                <i class="fas fa-paper-plane" id="send-button"></i>
            </div>
        </div>
    </div>

    <!-- SAÄž ARKADAÅž LÄ°STESÄ° -->
    <div class="users-panel" id="friends-panel">
        <div class="users-title">
            ArkadaÅŸlar
            <i class="fas fa-user-plus" id="add-friend-btn" onclick="openFriendModal()" style="cursor:pointer;"></i>
        </div>
        <div id="friends-list"></div>
        <div class="users-title" style="margin-top:20px;">Direkt Mesajlar</div>
        <div id="dm-list"></div>
    </div>

    <!-- MODALLAR -->
    <!-- KullanÄ±cÄ± adÄ± modalÄ± (ilk giriÅŸ) -->
    <div class="modal active" id="username-modal">
        <div class="modal-content">
            <h2>âœ¨ ArkadaÅŸ Sohbet'e HoÅŸ Geldin</h2>
            <p>KullanÄ±cÄ± adÄ±nÄ± gir, hemen baÅŸla!</p>
            <input type="text" id="modal-username" placeholder="KullanÄ±cÄ± adÄ±" value="">
            <button id="modal-username-save">BaÅŸla</button>
            <button class="secondary" id="modal-username-cancel">Ä°ptal</button>
        </div>
    </div>

    <!-- Sunucu oluÅŸturma modalÄ± -->
    <div class="modal" id="server-modal">
        <div class="modal-content">
            <h2>âž• Yeni Sunucu OluÅŸtur</h2>
            <input type="text" id="new-server-name" placeholder="Sunucu adÄ±">
            <button onclick="createServer()">OluÅŸtur</button>
            <button class="secondary" onclick="closeServerModal()">Ä°ptal</button>
        </div>
    </div>

    <!-- ArkadaÅŸ ekleme modalÄ± -->
    <div class="modal" id="friend-modal">
        <div class="modal-content">
            <h2>ðŸ‘¤ ArkadaÅŸ Ekle</h2>
            <input type="text" id="friend-username" placeholder="KullanÄ±cÄ± adÄ±">
            <button onclick="addFriend()">Ekle</button>
            <button class="secondary" onclick="closeFriendModal()">Ä°ptal</button>
        </div>
    </div>

    <!-- Gizli dosya inputu -->
    <input type="file" id="file-input" accept="image/*" onchange="uploadImage(this)">

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCXca2LRaHFx6iZX9vhfe6lXMS9UY5nO54",
            authDomain: "rysu-server.firebaseapp.com",
            databaseURL: "https://rysu-server-default-rtdb.firebaseio.com",
            projectId: "rysu-server",
            storageBucket: "rysu-server.firebasestorage.app",
            messagingSenderId: "253844771451",
            appId: "1:253844771451:web:bd370ae5a93eae66fcc8de",
            measurementId: "G-T632DDDX6L"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        // Global deÄŸiÅŸkenler
        let currentUser = localStorage.getItem('chat_username') || null;
        let currentServer = 'genel';
        let currentChannel = 'genel';
        let currentDMFriend = null;

        // DOM elementleri
        const usernameModal = document.getElementById('username-modal');
        const modalUsernameInput = document.getElementById('modal-username');
        const modalUsernameSave = document.getElementById('modal-username-save');
        const modalUsernameCancel = document.getElementById('modal-username-cancel');
        const serverModal = document.getElementById('server-modal');
        const friendModal = document.getElementById('friend-modal');
        const messagesContainer = document.getElementById('messages-container');
        const channelListDiv = document.getElementById('channel-list');
        const currentChannelSpan = document.getElementById('current-channel');
        const serverNameSpan = document.getElementById('server-name-text');
        const currentUsernameSpan = document.getElementById('current-username');
        const avatarLetter = document.getElementById('avatar-letter');
        const chatHeaderIcon = document.getElementById('channel-icon');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const fileInput = document.getElementById('file-input');

        // KullanÄ±cÄ± adÄ± kontrolÃ¼
        if (currentUser) {
            usernameModal.classList.remove('active');
            initApp();
        } else {
            usernameModal.classList.add('active');
        }

        modalUsernameSave.addEventListener('click', () => {
            const name = modalUsernameInput.value.trim();
            if (name) {
                currentUser = name;
                localStorage.setItem('chat_username', currentUser);
                usernameModal.classList.remove('active');
                db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
                initApp();
            } else {
                alert('LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin.');
            }
        });

        modalUsernameCancel.addEventListener('click', () => {
            currentUser = 'ArkadaÅŸ';
            localStorage.setItem('chat_username', currentUser);
            usernameModal.classList.remove('active');
            db.ref('users/' + currentUser).set({ username: currentUser, lastSeen: Date.now() });
            initApp();
        });

        function initApp() {
            currentUsernameSpan.textContent = currentUser;
            avatarLetter.textContent = currentUser.charAt(0).toUpperCase();

            // VarsayÄ±lan sunucuyu kontrol et
            db.ref('servers/genel').once('value', (snap) => {
                if (!snap.exists()) {
                    db.ref('servers/genel').set({
                        name: 'genel',
                        channels: { genel: true, random: true, sohbet: true }
                    });
                }
            });

            // Sunucu listesini dinle
            db.ref('servers').on('value', (snap) => {
                renderServerList(snap.val() || {});
            });

            // ArkadaÅŸ listesini dinle
            db.ref('users/' + currentUser + '/friends').on('value', (snap) => {
                renderFriendsList(snap.val() || {});
            });

            // VarsayÄ±lan sunucuya geÃ§
            switchServer('genel');
        }

        function renderServerList(serversData) {
            let html = '';
            for (let id in serversData) {
                const activeClass = (id === currentServer && !currentDMFriend) ? 'active' : '';
                html += `<div class="server-icon ${activeClass}" onclick="switchServer('${id}')">${serversData[id].name.charAt(0).toUpperCase()}</div>`;
            }
            html += `<div class="server-divider"></div>`;
            html += `<div class="server-icon add-server" onclick="openServerModal()"><i class="fas fa-plus"></i></div>`;
            html += `<div class="server-icon dm ${!currentServer && currentDMFriend ? 'active' : ''}" onclick="openDMHome()"><i class="fas fa-comment"></i></div>`;
            document.getElementById('server-list').innerHTML = html;
        }

        function renderFriendsList(friendsData) {
            let friendsHtml = '';
            let dmHtml = '';
            for (let friend in friendsData) {
                friendsHtml += `<div class="user-item" onclick="openDM('${friend}')">
                    <div class="user-status"></div>
                    <span class="user-name">${friend}</span>
                </div>`;
                dmHtml += `<div class="user-item" onclick="openDM('${friend}')">
                    <div class="user-status"></div>
                    <span class="user-name">${friend}</span>
                </div>`;
            }
            document.getElementById('friends-list').innerHTML = friendsHtml;
            document.getElementById('dm-list').innerHTML = dmHtml;
        }

        function switchServer(serverId) {
            currentServer = serverId;
            currentDMFriend = null;
            document.getElementById('current-server-name').style.display = 'flex';
            serverNameSpan.textContent = serverId;
            // Sunucu ikonlarÄ±nÄ± gÃ¼ncelle (aktif sÄ±nÄ±fÄ±)
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            const activeServerIcon = Array.from(document.querySelectorAll('.server-icon')).find(el => el.textContent.trim() === serverId.charAt(0).toUpperCase());
            if (activeServerIcon) activeServerIcon.classList.add('active');
            // KanallarÄ± yÃ¼kle
            db.ref('servers/' + serverId + '/channels').once('value', (snap) => {
                const channels = snap.val() || {};
                let chHtml = '<div class="channel-category">METÄ°N KANALLARI</div>';
                for (let ch in channels) {
                    const active = (ch === currentChannel) ? 'active' : '';
                    chHtml += `<div class="channel ${active}" onclick="switchChannel('${ch}')"><i class="fas fa-hashtag"></i>${ch}</div>`;
                }
                channelListDiv.innerHTML = chHtml;
                // EÄŸer mevcut kanal bu sunucuda yoksa ilk kanala geÃ§
                if (!channels[currentChannel]) {
                    const firstCh = Object.keys(channels)[0] || 'genel';
                    switchChannel(firstCh);
                } else {
                    // Mevcut kanalÄ± yÃ¼kle
                    loadMessages('server', currentServer + '_' + currentChannel);
                }
            });
        }

        function switchChannel(channel) {
            currentChannel = channel;
            currentDMFriend = null;
            document.querySelectorAll('.channel').forEach(ch => ch.classList.remove('active'));
            const activeChannel = Array.from(document.querySelectorAll('.channel')).find(el => el.textContent.trim() === channel);
            if (activeChannel) activeChannel.classList.add('active');
            currentChannelSpan.textContent = channel;
            chatHeaderIcon.className = 'fas fa-hashtag';
            loadMessages('server', currentServer + '_' + channel);
        }

        function openDM(friendUsername) {
            currentDMFriend = friendUsername;
            currentServer = null;
            // Sunucu ikonlarÄ±nÄ± gÃ¼ncelle
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            document.querySelector('.server-icon.dm').classList.add('active');
            document.getElementById('current-server-name').style.display = 'none';
            channelListDiv.innerHTML = '<div class="channel-category">DM</div><div class="channel active"><i class="fas fa-comment"></i> ' + friendUsername + '</div>';
            currentChannelSpan.textContent = friendUsername;
            chatHeaderIcon.className = 'fas fa-comment';
            const roomId = [currentUser, friendUsername].sort().join('_');
            loadMessages('dm', roomId);
        }

        function openDMHome() {
            currentDMFriend = null;
            currentServer = null;
            document.querySelectorAll('.server-icon').forEach(ic => ic.classList.remove('active'));
            document.querySelector('.server-icon.dm').classList.add('active');
            document.getElementById('current-server-name').style.display = 'none';
            channelListDiv.innerHTML = '<div class="channel-category">DOÄžRUDAN MESAJLAR</div><div class="channel"><i class="fas fa-info-circle"></i> Bir arkadaÅŸ seÃ§in</div>';
            currentChannelSpan.textContent = 'Direkt Mesajlar';
            chatHeaderIcon.className = 'fas fa-comment';
            messagesContainer.innerHTML = '';
        }

        function loadMessages(type, id) {
            messagesContainer.innerHTML = '';
            let ref = (type === 'server') ? db.ref('messages/server/' + id) : db.ref('messages/dm/' + id);
            ref.off();
            ref.orderByChild('timestamp').on('child_added', (snap) => {
                const msg = snap.val();
                appendMessage(msg);
            });
        }

        function appendMessage(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            if (msg.username === currentUser) {
                messageDiv.classList.add('own-message');
            }
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : '';
            const avatarLetter = msg.username ? msg.username.charAt(0).toUpperCase() : '?';
            let contentHtml = '';
            if (msg.text) {
                contentHtml += `<div class="message-text">${escapeHtml(msg.text)}</div>`;
            }
            if (msg.imageUrl) {
                contentHtml += `<img src="${escapeHtml(msg.imageUrl)}" class="message-image" onclick="window.open(this.src)">`;
            }
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarLetter}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${escapeHtml(msg.username)}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    ${contentHtml}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function sendMessage(text, imageUrl = null) {
            if (!text && !imageUrl) return;
            let ref;
            if (currentDMFriend) {
                const roomId = [currentUser, currentDMFriend].sort().join('_');
                ref = db.ref('messages/dm/' + roomId);
            } else {
                ref = db.ref('messages/server/' + currentServer + '_' + currentChannel);
            }
            const msg = {
                username: currentUser,
                text: text || '',
                timestamp: Date.now(),
            };
            if (imageUrl) msg.imageUrl = imageUrl;
            ref.push(msg);
        }

        sendButton.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text) {
                sendMessage(text);
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const text = messageInput.value.trim();
                if (text) {
                    sendMessage(text);
                    messageInput.value = '';
                }
            }
        });

        // Resim yÃ¼kleme
        window.uploadImage = (input) => {
            const file = input.files[0];
            if (!file) return;
            const storageRef = storage.ref('images/' + Date.now() + '_' + file.name);
            const task = storageRef.put(file);
            task.on('state_changed', null, null, () => {
                task.snapshot.ref.getDownloadURL().then(url => {
                    sendMessage('', url);
                });
            });
        };

        // Modal iÅŸlevleri
        window.openServerModal = () => {
            serverModal.classList.add('active');
        };
        window.closeServerModal = () => {
            serverModal.classList.remove('active');
            document.getElementById('new-server-name').value = '';
        };
        window.createServer = () => {
            const name = document.getElementById('new-server-name').value.trim();
            if (name) {
                db.ref('servers/' + name).set({
                    name: name,
                    channels: { genel: true, random: true, sohbet: true }
                });
                closeServerModal();
                switchServer(name);
            } else {
                alert('Sunucu adÄ± boÅŸ olamaz.');
            }
        };

        window.openFriendModal = () => {
            friendModal.classList.add('active');
        };
        window.closeFriendModal = () => {
            friendModal.classList.remove('active');
            document.getElementById('friend-username').value = '';
        };
        window.addFriend = () => {
            const friendName = document.getElementById('friend-username').value.trim();
            if (friendName && friendName !== currentUser) {
                db.ref('users/' + friendName).once('value', (snap) => {
                    if (snap.exists()) {
                        db.ref('users/' + currentUser + '/friends/' + friendName).set(Date.now());
                        db.ref('users/' + friendName + '/friends/' + currentUser).set(Date.now());
                        closeFriendModal();
                    } else {
                        alert('Bu kullanÄ±cÄ± bulunamadÄ±.');
                    }
                });
            } else {
                alert('GeÃ§erli bir kullanÄ±cÄ± adÄ± girin.');
            }
        };
    </script>
</body>
</html>